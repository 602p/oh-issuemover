{"status": "resolved", "priority": "bug", "title": "Error when submitting a avatar", "milestone": "0.10.11", "superceder": "", "nosylist": ["jesstess, paulproteus, richizo"], "assigned": "jesstess", "waitingon": "", "keywords": ["avatar"], "id": "166", "files": [{"url": "http://openhatch.org/bugs/file98/gir_major.png", "author": "richizo"}, {"url": "http://openhatch.org/bugs/file100/gir_major_converted.png", "author": "jesstess"}, {"url": "http://openhatch.org/bugs/file103/issue166.tar.gz", "author": "jesstess"}, {"url": "http://openhatch.org/bugs/file102/pil_test.py", "author": "jesstess"}, {"url": "http://openhatch.org/bugs/file101/traceback.txt", "author": "jesstess"}], "history": [{"message": "Marking as resolved, 'cause we shipped it and it passes the tests!\n\nRich, do give this another shot now.\n   \n", "author": "paulproteus"}, {"message": "Jess, thanks for looking into this in such depth.\n\nre: \"parts\": That's created by buildout. Code like Django gets copied into there.\n\nI can explain more, but maybe that's enough?\n\nI'll push this right now, but I'll need a bit to fix up my local setup so that I\ncan test it well. I also added one patch on top to fix a spelling error in a\nmethod name.\n   \n", "author": "paulproteus"}, {"message": "Attached is a tarball with a diff that has the site fail gracefully if an\nexception is raised during image processing, instead of returning a 500, as well\nas unit tests for this case and the separate but related case of uploading a\nprofile photo that Django catches as invalid. There are two other commits\nremoving unused imports/variables.\n\nI noticed while writing this that large portions of the OpenHatch code,\nincluding parts/, where the image processing happens, aren't in git. I took this\nto mean \"don't touch them\" and worked with what I had left, but I'd be\ninterested in hearing why this is the setup (the patch probably would have been\ndifferent, too).\n\nThe changes pass test_sans_customs and visual inspection.\n   \n", "author": "jesstess"}, {"message": "The uncaught Exception is:\n\n&lt;class 'zlib.error'&gt; Error -5 while decompressing data: incomplete or truncated\nstream \n\n(I've attached the full traceback as traceback.txt)\n\nDigging into why this particular image causes this error has taken me down a bit\nof a rabbit hole. If you run pil_test.py in the directory with 'gir_major.png',\nyou'll see that this error is only generated when the PIL PNG parser is fed the\nPNG in chunks. If you feed it the whole file at once, there's no problem.\n\nThis suggests a bug in the PIL PNG parser, but I don't understand why chunking\nother PNGs doesn't cause the same problem. I'll write up a bug report/inquiry\nfor the PIL folks when I have more information.\n   \n", "author": "jesstess"}, {"message": "richizo, I also get a 500 when trying to upload your file as my profile picture.\nOther pngs work, and if I convert your picture to another format and then back\nto a png, uploading that new image works too.\n\nThis suggests that your png is corrupted, but I ran through both of the quick\nways to detect corrupted pngs on\n\n<a href=\"http://stackoverflow.com/questions/2383973/an-efficient-way-to-detect-corrupted-png-files\">http://stackoverflow.com/questions/2383973/an-efficient-way-to-detect-corrupted-png-files</a>\n\nand there was no problem.\n\nSo, in the short term, can you use a different image (I've attached the\npng-to-gif-to-png version of your original file, if you want to use that)? In\nthe long term, paulproteus, you have access to the server logs and can hopefully\nfind out more. This is 100% repeatable with richizo's image, as far as I can tell.\n   \n", "author": "jesstess"}, {"message": "Yes, the error still occurring. I attached the image that I tried to submit.\n\nThanks.\n   \n", "author": "richizo"}, {"message": "Hi richizo, and thanks for reporting this.\n\nI wasn't able to reproduce this today (I tried changing my profile picture to a\nvariety of file types and sizes). Does this still happen for you?\n   \n", "author": "jesstess"}, {"message": "Always when I try to submit a avatar (photo) at page[1], after clicking on \n\"Upload\" button, the site is redirected to other page[2] and a error 500 is \nshowed (server error).\n\nPS.: I'm trying to submit a figure in pgn format with 124KB.\n\n[1] - <a href=\"http://openhatch.org/account/edit/photo/\">http://openhatch.org/account/edit/photo/</a>\n[2] - <a href=\"http://openhatch.org/account/edit/photo/do\">http://openhatch.org/account/edit/photo/do</a>\n   \n", "author": "richizo"}]}