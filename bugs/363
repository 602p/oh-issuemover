{"status": "resolved", "priority": "feature", "title": "Migrate Trac bug importer to Twisted", "milestone": "0.11.03", "superceder": "", "nosylist": ["paulproteus, pythonian4000"], "assigned": "pythonian4000", "waitingon": "", "keywords": [], "id": "363", "files": [{"url": "http://openhatch.org/bugs/file199/importer_async_architecture.png", "author": "pythonian4000"}], "history": [{"message": "Okay! I did a longer patch review on IRC, and there are some code cleanup-type\nissues remaining, but this is totally good enough to land.\n\n(It sets the stage for async-ifying the other bug tracker import code, which\nwill make everything so flippin' sweet.)\n   \n", "author": "paulproteus"}, {"message": "Fixes for the various errors and failures that I somehow missed in all the rebasing.\n\n<a href=\"http://git.jackgrigg.com/openhatch/patch/?id=c9e14c65c66fa3ce3a33747d674ccc1daea88504\">http://git.jackgrigg.com/openhatch/patch/?id=c9e14c65c66fa3ce3a33747d674ccc1daea88504</a>\n<a href=\"http://git.jackgrigg.com/openhatch/patch/?id=4de9ad9c0f915d946f0a8c7d4c4f3bfbf3be4d01\">http://git.jackgrigg.com/openhatch/patch/?id=4de9ad9c0f915d946f0a8c7d4c4f3bfbf3be4d01</a>\n   \n", "author": "pythonian4000"}, {"message": "Done! Finally! The patch series is here:\n<a href=\"http://git.jackgrigg.com/openhatch/log/?h=twisted-importer\">http://git.jackgrigg.com/openhatch/log/?h=twisted-importer</a>\n\nRelevant patches in-order are:\n<a href=\"http://git.jackgrigg.com/openhatch/patch/?id=65cea831f50fe631487dce367d47e2cb8d22806e\">http://git.jackgrigg.com/openhatch/patch/?id=65cea831f50fe631487dce367d47e2cb8d22806e</a>\n<a href=\"http://git.jackgrigg.com/openhatch/patch/?id=f069643a694b8f2734cd5f15a047bff527edfea2\">http://git.jackgrigg.com/openhatch/patch/?id=f069643a694b8f2734cd5f15a047bff527edfea2</a>\n<a href=\"http://git.jackgrigg.com/openhatch/patch/?id=ec9e6cedb2ce0c3deda246a65dda998d4b9d3267\">http://git.jackgrigg.com/openhatch/patch/?id=ec9e6cedb2ce0c3deda246a65dda998d4b9d3267</a>\n<a href=\"http://git.jackgrigg.com/openhatch/patch/?id=b3e9592169646a6f5069915acc9ad5737040f1cb\">http://git.jackgrigg.com/openhatch/patch/?id=b3e9592169646a6f5069915acc9ad5737040f1cb</a>\n<a href=\"http://git.jackgrigg.com/openhatch/patch/?id=d32319699edf0437fd828eaedbaf7574fa18802c\">http://git.jackgrigg.com/openhatch/patch/?id=d32319699edf0437fd828eaedbaf7574fa18802c</a>\n<a href=\"http://git.jackgrigg.com/openhatch/patch/?id=24a53cfd7f2e35f5cc3114fa3c59f16eefb98b1c\">http://git.jackgrigg.com/openhatch/patch/?id=24a53cfd7f2e35f5cc3114fa3c59f16eefb98b1c</a>\n<a href=\"http://git.jackgrigg.com/openhatch/patch/?id=251c1d426caba1ca308ef4efe037f04066e9b60d\">http://git.jackgrigg.com/openhatch/patch/?id=251c1d426caba1ca308ef4efe037f04066e9b60d</a>\n<a href=\"http://git.jackgrigg.com/openhatch/patch/?id=753ef202048c93c6963c3938b0a307d1d8ad412e\">http://git.jackgrigg.com/openhatch/patch/?id=753ef202048c93c6963c3938b0a307d1d8ad412e</a>\n   \n", "author": "pythonian4000"}, {"message": "You waxed enthusiastic on #openhatch earlier today about how this was all\nfinally working. Is there a fully-working version?\n\nIf not, I will take this work and diagnose any remaining issues tomorrow, and\nhopefully push it and deploy it, if I can figure out what's going wrong!\n\nIf there is a fully working version, then just submit that. (-:\n   \n", "author": "paulproteus"}, {"message": "After wrestling with South for many hours, I finally have 8 patches that should\nenable asynchronous bug importing. Trouble is, it doesn't work: the last patch,\nwhere the actual async code is, seems perfectly fine. But when running\n\"./bin/mysite customs_twist\" (after sticking heaps of print statements in to\ncheck where it was up to) it seems that none of the tracker-type-defined\ncallbacks or errbacks are being executed, i.e.:\n\nin push_urls_onto_reactor, the following callbacks get called:\nd.addCallback(callback, c_args)  &lt;- NO\nd.addErrback(errback, e_args) &lt;- NO\nd.addBoth(self.remove_url_from_deferred_list, url) &lt;- yes\nd.addBoth(self.push_urls_onto_reactor) &lt;- yes\nd.addBoth(self.rm.decrement_deferred_count) &lt;- yes\n\nand it also correctly sees when there are no more URLs left to fetch, but\nself.deferred_for_end.callback()\nnever seems to actually get called.\n\nAnd I'm tired, so I'm leaving it at this for now. Thoughts?\n   \n", "author": "pythonian4000"}, {"message": "re:\n<a href=\"http://git.jackgrigg.com/openhatch/commit/?h=twisted-importer&amp;id=ff91915d51c131a7b29750414b752f9477656763\">http://git.jackgrigg.com/openhatch/commit/?h=twisted-importer&amp;id=ff91915d51c131a7b29750414b752f9477656763</a>\n-- you don't necessarily have to use Trial if you test manually passing a 404 to\nthe errback.\n\nAlso, the FakeGetPage thing I created lets us test Twisted-y stuff without using\nTrial.\n   \n", "author": "paulproteus"}, {"message": "So...\n\nI'm trying, but I don't know if I'll have this completely ready by the deadline.\nI do have 5 patches that are self-contained band ready on\n<a href=\"http://git.jackgrigg.com/openhatch/?h=twisted-importer\">http://git.jackgrigg.com/openhatch/?h=twisted-importer</a>\n(from \"Added django-model-utils to buildout.\" to \"Enabled managing the\nTracTracker and TracURL models via web interface.\"). Note that these need to be\napplied on top of the work from <a href=\"issue328\">issue328</a> and <a href=\"issue317\">issue317</a> (because all three have\nSouth migrations, which have a certain \"order\" about them ~_~). You can leave\nout the patch migrating the Trac tests across if you want, as that is\nself-contained and will currently fail. I'll keep updating here and on IRC as I\nget closer to completion.\n   \n", "author": "pythonian4000"}, {"message": "Status update.\n\nCompleted:\n* copied the existing Trac tests over for the async code and modified as needed.\n* modified customs.models, adding some abstract parent models and getters.\n* added the TracTracker and TracUrl models.\n\nDone (not necessarily completely right):\n* written customs.bugimporters.base\n* drastically rewritten customs.bugtrackers.trac as customs.bugimporters.trac\n\nStill left:\n* Modify Asheesh's self-refreshing Bug code to integrate it into the\nasynchronous importer.\n* Write update_trackers() and update_bugs() in\nmanagement.commands.customs_twist, and integrate these into the reactor.\n* Other stuff I'll think of.\n   \n", "author": "pythonian4000"}, {"message": "Changing status to in-progress because I think we've reviewed the design, at\nthis point.\n   \n", "author": "paulproteus"}, {"message": "Adding requirement for Bugs to know how to update themselves as a blocker.\n\nSee <a href=\"http://piratepad.net/async-bug-importer\">http://piratepad.net/async-bug-importer</a> for planning relevant to this issue.\n   \n", "author": "pythonian4000"}, {"message": "This is tracked in <a href=\"issue260\">issue260</a>.\n\nAttached is a possible architecture for the Trac importer, which I think is\ngeneral enough to then abstract to other importers as well. The process_queries,\nprocess_bugs and check_deferred functions would be required by the base tracker\nclass, and implemented in the tracker type's class e.g. Trac. Functions and\ncallbacks below that would be tracker type-specific. update_trackers and\nupdate_bugs would then cover all tracker types.\n\nI need feedback on this, as this is my first attempt at writing asynchronous\nsoftware ^_^\n   \n", "author": "pythonian4000"}]}