{"status": "resolved", "priority": "bug", "title": "\"any\" Languages selection in search does not return any results", "milestone": "", "superceder": "", "nosylist": ["Aaron1011, kaizokuace, lalei, mandarg, paulproteus"], "assigned": "Aaron1011", "waitingon": "", "keywords": [], "id": "766", "files": [{"url": "http://openhatch.org/bugs/file543/0001-Fixed-the-any-option-when-filtering-by-language.patch", "author": "Aaron1011"}, {"url": "http://openhatch.org/bugs/file551/0001-Improved-fix-for-any-option.patch", "author": "Aaron1011"}, {"url": "http://openhatch.org/bugs/file553/0001-Made-tests-test-changed-functionality.patch", "author": "Aaron1011"}, {"url": "http://openhatch.org/bugs/file552/0005-Fixed-failing-FacetFilterResults-tests.patch", "author": "Aaron1011"}], "history": [{"message": "Resolved in <a href=\"https://github.com/openhatch/oh-\">https://github.com/openhatch/oh-</a>\nmainline/commit/32c9c8472755ad6ac98394c83fbe5ad748507791 , merged, and deployed.\n\nThank you Aaron1011!\n   \n", "author": "paulproteus"}, {"message": "The code here looks good to me, now that I understand it, but more comments \nand/or commit log messages are needed!\n   \n", "author": "paulproteus"}, {"message": "I have made a pull request that consolidates my patches here: \n<a href=\"https://github.com/openhatch/oh-mainline/pull/114\">https://github.com/openhatch/oh-mainline/pull/114</a>\n   \n", "author": "Aaron1011"}, {"message": "Hello again,\nI have made another patch that test the create_from_GET_data method. I'm sorry \nabout my earlier tests, I don't know what I was thinking!\n   \n", "author": "Aaron1011"}, {"message": "Hi Aaron! This is great, but the one thing that this patch doesn't have (which we \nneed) is a test case that covers the changed behavior.\n\nIn particular, all the tests that you have added (from what I can tell) pass \nwithout the change to mysite/search/view_helpers.py . So the tests only cover old \nbehavior.\n\nThe point of adding a test in this case is to prove that the code you wrote fixes \nan actual problem, so your test should be able to demonstrate a problem with the \ncode before your changes are applied.\n\nLet me know if I can clarify at all; IRC might be better to reach me! When you \narrive on IRC, feel free to ping me as paulproteus there (by just saying my name) \nso I am sure to see you. If I'm away, you'll know because I don't answer a ping.\n   \n", "author": "paulproteus"}, {"message": "I have uploaded a patch that fixes the failing tests. I didn't get the same error \nabout old_dbe, but a couple other tests started failing. The problem was changing \nthe else clause in create_from_GET_data. If a particular facet wasn't present at \nall in the GET data, the else clause would execute, because the if statement would \nevaluate to false. However, the any_facet option needs to be set to True only if a \nfacet is present but set to the empty string.\n\nMy patch change the else clause back to a test for the empty string.\n   \n", "author": "Aaron1011"}, {"message": "Hi Aaron!\n\nWhen I run the tests, I get some errors:\n\n(UNKNOWN CHARACTER)  oh-mainline git:(fix/<a href=\"issue766\">issue766</a>) (UNKNOWN CHARACTER) python manage.py test \nsearch.FacetsFilterResults\nCreating test database for alias 'default'...\nEE\n======================================================================\nERROR: test_any_facet (mysite.search.tests.FacetsFilterResults)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/paulproteus/projects/oh-mainline/mysite/search/tests.py\", line \n479, in setUp\n    self.python_bug = Bug.create_dummy(project=python_project)\nNameError: global name 'python_project' is not defined\n\n======================================================================\nERROR: test_facets_filter_results (mysite.search.tests.FacetsFilterResults)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/paulproteus/projects/oh-mainline/mysite/search/tests.py\", line \n479, in setUp\n    self.python_bug = Bug.create_dummy(project=python_project)\nNameError: global name 'python_project' is not defined\n\n----------------------------------------------------------------------\nRan 2 tests in 0.004s\n\nFAILED (errors=2)\nDestroying test database for alias 'default'...\n\nIn particular, this is because on line 479 you need to write \nproject=self.python_project.\n\nOnce I fix that, I get this VERY obscure error:\n\n======================================================================\nERROR: test_any_facet (mysite.search.tests.FacetsFilterResults)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/paulproteus/projects/oh-mainline/mysite/base/tests.py\", line 95, \nin tearDown\n    settings.DEBUG_PROPAGATE_EXCEPTIONS = self.old_dbe\nAttributeError: 'FacetsFilterResults' object has no attribute 'old_dbe'\n\nwhich is caused by the setUp() method not calling the super() class's setUp(). \nSo I added that on top in this patch:\n\ndiff --git a/mysite/search/tests.py b/mysite/search/tests.py\nindex ce270bc..e3bcf8a 100644\n--- a/mysite/search/tests.py\n+++ b/mysite/search/tests.py\n@@ -475,11 +475,12 @@ class SearchTemplateDecodesQueryString(SearchTest):\n \n class FacetsFilterResults(SearchTest):\n     def setUp(self):\n+        super(FacetsFilterResults, self).setUp()\n         self.python_project = Project.create_dummy(language='Python')\n-        self.python_bug = Bug.create_dummy(project=python_project)\n+        self.python_bug = Bug.create_dummy(project=self.python_project)\n \n         self.not_python_project = Project.create_dummy(language='Nohtyp')\n-        self.not_python_bug = Bug.create_dummy(project=not_python_project)\n+        self.not_python_bug = Bug.create_dummy(project=self.not_python_project)\n \nHowever, I still find that when I revert your changes to view_helpers.py, the \ntest you provide still passes. So I won't merge this yet; I don't think we're at \nthe bottom of the issue.\n\nI would focus on using the interactive shell (e.g., python manage.py shell_plus) \nto interactively fiddle with the Query class and its create_from_GET_data \nmethod, and see if you can identify what the wrong behavior is and identify a \nfix. I think that the change you made actually doesn't fix the underlying issue, \nthough I'm not totally sure without a test case that covers this behavior.\n\nThanks for your patience with me, and I'm looking forward to us getting to the \nbottom of this together!\n   \n", "author": "paulproteus"}, {"message": "Thank you for you advice! I have uploaded a new patch that implements your \nsuggestions.\n   \n", "author": "Aaron1011"}, {"message": "Hi Aaron! Thank you for this patch, and sorry about the build-up here in the \nreview queue.\n\nI noticed that your patch no longer applies, so I took the liberty of rebasing it \nbefore testing. You can keep working on the version you have, or rebase it \nyourself. (The reason it doesn't apply to the current master on \n<a href=\"http://github.com/openhatch/oh-mainline\">http://github.com/openhatch/oh-mainline</a> is that we renamed the controllers files \nto be named view_helpers.) It's OK by me if you submit it against an old version \nof the code, since I can merge that myself.\n\nI also noticed that your test seems to pass even without your code changes. This \nmakes it hard to judge if the code changes are correct.\n\nA few thoughts on the code changes:\n\n\nI notice that you check if GET.get(facet) equals the empty string, but on the \nlines above that, I think we already test that implicitly with \"if \nGET.get(facet):\". So perhaps it would be better instead of writing:\n\n            if GET.get(facet) == '':\n                any_facet = True\n\nto write:\n\n            else:\n                any_facet = True\n\nAnother thing I noticed is that your code is changing the behavior of the \ncreate_from_GET_data function. So your test might as well just test that method.\n\nThank you for this patch! I'm happy to help more; let me know what you think of \nthe above!\n   \n", "author": "paulproteus"}, {"message": "I'm super excited, and will review this patch tomorrow!\n   \n", "author": "paulproteus"}, {"message": "Added patch.\n   \n", "author": "Aaron1011"}, {"message": "I think it's depending on either we want to show the list of all bugs or not.\nIf we want to show it, it needs to show the list of all bugs when \"any\" is \nclicked on \"Languages\" and also on \"Projects\".\nIf not, \"any\" links should be removed.\n   \n", "author": "lalei"}, {"message": "Steps to reproduce. (Seen on Firefox and Chrome on Mac, pretty sure this is\nbrowser/OS independent though)\n\n1. Go to <a href=\"http://www.openhatch.org/search/\">http://www.openhatch.org/search/</a>\n\n2. Under 'Languages', click on \"More Languages\"\n\n3. In the overlay, there is a selection called \"any\". Click on it.\n\n!4. No work items are shown, though the total number is correctly shown beside\n\"any\" in the overlay. The URL with query string that the selection leads to is\n<a href=\"https://openhatch.org/search/?q=&amp;language=\">https://openhatch.org/search/?q=&amp;language=</a>\n   \n", "author": "mandarg"}]}