{"status": "resolved", "priority": "bug", "title": "Crasher bug in the diffsingle training mission", "milestone": "0.11.07", "superceder": "", "nosylist": ["jesstess, paulproteus"], "assigned": "jesstess", "waitingon": "", "keywords": [], "id": "484", "files": [{"url": "http://openhatch.org/bugs/file385/0001-If-a-diffpatch-diff-is-submitted-without-diff-header.patch", "author": "jesstess"}], "history": [{"message": "This is deployed now. Turns out your fix was pretty simple!\n\nI agree that we've done a not-so-great thing by just including this patch.py\nlibrary from <a href=\"http://code.google.com/p/python-patch/\">http://code.google.com/p/python-patch/</a>\n\nBack when we got it, I think it felt abandoned, and I think it didn't have a\nsetup.py (although my memory is hazy). It seems quite active now!\n<a href=\"http://code.google.com/p/python-patch/source/list?num=25&amp;start=121\">http://code.google.com/p/python-patch/source/list?num=25&amp;start=121</a>\n\nWe should work on upstreaming our slight changes in this case and/or just\nditching our version and running the test suite with upstream's version listed\nas a dependency.\n\nI'll mark that as a different bug: <a href=\"issue562\">issue562</a> . For now, this is resolved!\n   \n", "author": "paulproteus"}, {"message": "The crash can be exercised by submitting anything that lacks diff headers.\n\nAttached is a patch with a unit test that prints a hint to include those headers instead of crashing. \nThis bug also existed for the diffrecursive sub-mission and is fixed by this patch.\n\nI have some commentary on our use of mysite/missions/base/patch.py: we seem to be using code \ncopied from <a href=\"http://code.google.com/p/python-patch/.\">http://code.google.com/p/python-patch/.</a> A) this means we aren't seeing upstream \nfixes unless someone is remembering to pull them in regularly, B) I think the line-by-line parsing is \noverkill for the kind of validation we need, and C) it has a bunch of todos and no unit tests, which \nsuggests that there are more bugs lurking.\n\nIf more bugs crop up, we should consider moving to simpler validation.\n   \n", "author": "jesstess"}, {"message": "Here's the stack trace from a few minutes ago:\n\nTraceback (most recent call last):\n\n  File\n\"/home/deploy/milestone-a.buildout/parts/production/django/core/handlers/base.py\",\nline 100, in get_response\n    response = callback(request, *callback_args, **callback_kwargs)\n\n  File\n\"/home/deploy/milestone-a.buildout/parts/production/django/contrib/auth/decorators.py\",\nline 25, in\n_wrapped_view\n    return view_func(request, *args, **kwargs)\n\n  File \"/home/deploy/milestone-a.buildout/mysite/missions/diffpatch/views.py\",\nline 69, in diffsingle_submit\n    controllers.DiffSingleFileMission.validate_patch(form.cleaned_data['diff'])\n\n  File\n\"/home/deploy/milestone-a.buildout/mysite/missions/diffpatch/controllers.py\",\nline 31, in validate_patch\n    the_patch = patch.fromstring(patchdata)\n\n  File \"/home/deploy/milestone-a.buildout/mysite/missions/base/patch.py\", line\n67, in fromstring\n    return Patch( StringIO(s) )\n\n  File \"/home/deploy/milestone-a.buildout/mysite/missions/base/patch.py\", line\n118, in __init__\n    self.parse(stream)\n\n  File \"/home/deploy/milestone-a.buildout/mysite/missions/base/patch.py\", line\n325, in parse\n    self.hunks[nextfileno-1].append(hunkinfo.copy())\n\nIndexError: list index out of range\n\nThis is the POST data that was submitted:\n\nPOST:&lt;QueryDict: {u'diff': [u\"This mission is to have you make modifications to\na file and submit a\\r\\ndiff of\nthem. The changes may seem a bit silly, but they will cause the\\r\\ndiff to\ncontain examples of different types of\nchanges - additions,\\r\\ndeletions, and changes. Here is what we want you to do\nto this file:\\r\\n\\r\\n  1.  Keep an\nunmodified copy of this file handy; you'll need it to\\r\\n      make the diff\nonce you're finished.\\r\\n\\r\\n  2.  Try\nto keep the formatting intact, as the result file will be\\r\\n      compared\ncharacter-for-character. There is\nexactly one blank line\\r\\n      between each paragraph and bullet point, and all\nindentation is\\r\\n      done with\nspaces. There is never trailing whitespace.\\r\\n\\r\\n  3.  Delete this step (and\nthe blank line below it). (Don't\nrenumber the\\r\\n      ones below it.)\\r\\n\\r\\n  4.  Leave this step the way it\nis.\\r\\n\\r\\n  5.  Move this step so it\ncomes between #1 and #2. (Again, don't\\r\\n      renumber the steps.)\\r\\n\\r\\n  6.  \n Make an exact copy of this step and place it before #1; change the\\r\\n     \ncopy's step number to be 0.\\r\\n\\r\\n\n7.  There is a typo in this step, which oyu should fix.\\r\\n\\r\\n  8.  Save the\nchanges and make a unified diff of\nyour changes using the\\r\\n      diff command. Submit the diff on the page from\nwhich you obtained\\r\\n      this\nfile.\\r\\n\\r\\nGood luck!\\r\\n\"]}&gt;,\n\nTo fix this, you should first write a test that reproduces the crash. Then,\nchange the code until the test passes.\n<a href=\"http://openhatch.org/wiki/Automated_testing\">http://openhatch.org/wiki/Automated_testing</a> explains how we do testing in the code.\n   \n", "author": "paulproteus"}]}