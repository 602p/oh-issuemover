{"status": "resolved", "priority": "urgent", "title": "profile_daily_tasks takes more than one day on the deployment", "milestone": "0.11.11", "superceder": "", "nosylist": ["gameguy43, paulproteus"], "assigned": "paulproteus", "waitingon": "", "keywords": ["performance"], "id": "559", "files": [], "history": [{"message": "I made a bunch of fixes, and now the garbage-collection of Forwarder objects\noccurs within about 10-20 seconds rather than &gt;1 day. Deployed (and covered with\ntests).\n\nParker, in case you're interested in how I improved your code: check out\nmysite/profile/models.py -- look at Forwarder.garbage_collect(). I moved a bunch\nof your looping into SQL queries, which with &gt;6000 users makes a world of a\ndifference.\n   \n", "author": "paulproteus"}, {"message": "I'm going to take a look at this now.\n\nFrom a cursory glance, it seems that profile_daily_tasks does only two things:\n\n1. Garbage-collect the Forwarder objects\n\n2. If weekly project wannahelper notifications need to be sent, then we send them.\n\nGiven that weekly wannahelper notifications run pretty quickly, this suggests\nthe problem is in Forwarder.garbage_collect(). I'll take a look at optimizing\nthat now.\n   \n", "author": "paulproteus"}, {"message": "I hereby nominate this for 0.11.11. This is pretty important.\n   \n", "author": "paulproteus"}, {"message": "This is important, as it frequently causes the site to be very slow (by chewing\nup lots of MySQL time as well as CPU time). It's not yet done, though.\n   \n", "author": "paulproteus"}, {"message": "This does not fundamentally affect site stability, so I am pushing it back to \n0.11.09.\n   \n", "author": "paulproteus"}, {"message": "In line with the release theme of \"stability,\" one issue that faces us is \nthat profile_daily_tasks takes more than one day.\n\nWe should find out why. This investigation starts with reading the \nprofile_daily_tasks management command's source code, and the next step is to \nfigure out which steps are taking so long. Interestingly, the \nprofile_daily_tasks process seems to be using up all the CPU when it runs, \nsuggesting that there is Python code that could be sped-up.\n   \n", "author": "paulproteus"}]}